<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P File Sharing</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-5">
    <h1 class="text-3xl font-bold mb-4">P2P File Sharing</h1>

    <!-- Display Peer ID -->
    <div class="mb-4">
        <p>Your Peer ID: <span id="peerId" class="font-mono text-blue-600">Generating...</span></p>
    </div>

    <!-- File Upload -->
    <div class="flex gap-2 mb-4">
        <input type="file" id="fileInput" multiple class="p-2 border border-gray-300 rounded">
        <button id="sendFile" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Send</button>
    </div>

    <!-- Connection Details -->
    <div class="flex gap-2 mb-4">
        <input type="text" id="remoteId" placeholder="Enter Remote ID"
            class="p-2 border border-gray-300 rounded">
        <button id="connect" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Connect</button>
    </div>

    <p id="status" class="text-gray-700 mb-4">Status: Disconnected</p>

    <!-- Transfer Status -->
    <div id="transferStatus" class="w-full max-w-xl space-y-4"></div>

    <script>
        const peer = new Peer({
            host: '0.peerjs.com',
            port: 443,
            path: '/',
            secure: true,
        });

        let conn;
        const fileInput = document.getElementById('fileInput');
        const sendFileButton = document.getElementById('sendFile');
        const remoteIdInput = document.getElementById('remoteId');
        const connectButton = document.getElementById('connect');
        const status = document.getElementById('status');
        const transferStatus = document.getElementById('transferStatus');

        peer.on('open', (id) => {
            document.getElementById('peerId').innerText = id;
        });

        peer.on('connection', (connection) => {
            conn = connection;
            setupConnection();
        });

        connectButton.addEventListener('click', () => {
            const remoteId = remoteIdInput.value.trim();
            if (remoteId) {
                conn = peer.connect(remoteId);
                setupConnection();
            }
        });

        sendFileButton.addEventListener('click', () => {
            if (fileInput.files.length > 0 && conn && conn.open) {
                Array.from(fileInput.files).forEach(file => sendFile(file));
            } else {
                alert('No file selected or no connection established');
            }
        });

        function setupConnection() {
            conn.on('open', () => {
                status.innerText = `Connected to ${conn.peer}`;
            });

            conn.on('data', (data) => {
                if (data.file) {
                    saveFile(data.file);
                }
            });

            conn.on('close', () => {
                status.innerText = 'Disconnected';
            });

            conn.on('error', (err) => {
                console.error(err);
                status.innerText = 'Error in connection';
            });
        }

        function sendFile(file) {
            const reader = new FileReader();
            reader.onload = () => {
                const data = reader.result;
                conn.send({ file: { name: file.name, data } });
                addFileToUI(file.name, 'Sent');
            };
            reader.readAsArrayBuffer(file);
        }

        function saveFile(file) {
            const blob = new Blob([file.data]);
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            a.click();
            window.URL.revokeObjectURL(url);
            addFileToUI(file.name, 'Received');
        }

        function addFileToUI(fileName, statusText) {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-2 bg-white border rounded mb-2';
            div.innerHTML = `<span>${fileName}</span><span>${statusText}</span>`;
            transferStatus.appendChild(div);
        }
    </script>
</body>

</html>
